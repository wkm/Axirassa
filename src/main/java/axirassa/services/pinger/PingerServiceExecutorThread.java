package axirassa.services.pinger;import java.util.concurrent.Callable;import lombok.extern.slf4j.Slf4j;import org.hornetq.api.core.client.ClientMessage;import zanoccio.javakit.lambda.Function1;import axirassa.messaging.util.AbortSurvivorMessageException;import axirassa.messaging.util.CommonBackoffStrategies;import axirassa.messaging.util.InfiniteLoopExceptionSurvivor;import axirassa.model.HttpStatisticsEntity;import axirassa.model.PingerEntity;import axirassa.util.MessagingTools;@Slf4jpublic class PingerServiceExecutorThread implements Runnable {	private PingerServiceCoordinator pingRequestQueue;	private PingerServiceCoordinator pingResponseQueue;	private HttpPinger pinger;	public PingerServiceExecutorThread(	PingerServiceCoordinator pingRequestQueue,			PingerServiceCoordinator pingResponseQueue) {		this.pingRequestQueue = pingRequestQueue;		this.pingResponseQueue = pingResponseQueue;		this.pinger = new HttpPinger();	}	@Override	public void run() {		InfiniteLoopExceptionSurvivor executor = new InfiniteLoopExceptionSurvivor(		        CommonBackoffStrategies.EXPONENTIAL_BACKOFF_MESSAGING(),		        new Callable<Object>() {			        @Override			        public Object call() throws Exception {			        	log.info("#### STARTING THREAD");			        	PingerServiceCoordinationMessage coordinationMessage = null;			        	log.info("SYNCHRONIZING ON PING REQUEST QUEUE");				        synchronized (pingRequestQueue) {					        while(pingRequestQueue.isEmpty()) {					        	log.info("EMPTY REQUEST QUEUE. WAITING");					        	pingRequestQueue.wait();					        }					        					        log.info("PULLING MESSAGE FROM REQUEST QUEUE");					        coordinationMessage = pingRequestQueue.pollFirst();				        }				        				        // kill this survivor				        if (coordinationMessage.isShutdownMessage()) {					        log.info("Received shutdown message for thread");					        throw new AbortSurvivorMessageException();				        } 				        ClientMessage message = coordinationMessage.getClientMessage();				        PingerEntity entity = MessagingTools.fromMessageBytes(PingerEntity.class, message);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            				        System.out.println("PING " + entity.getUrl());				        HttpStatisticsEntity statistic = pinger.ping(entity);				        System.out.printf("%50s  TRIGGERS: %s\n", entity.getUrl(), pinger.getTriggers());				        				        coordinationMessage.setStatistic(statistic);				        				        log.info("SYNCHRONIZING ON **RESPONSE** QUEUE");				        synchronized (pingResponseQueue) {					        pingResponseQueue.append(coordinationMessage);					        log.info("APPENDED MESSAGE TO RESPONSE QUEUE");					        pingResponseQueue.notify();				        }				        return null;			        }		        }, new Function1<Boolean, Throwable>() {			        @Override			        public Boolean call(Throwable e) throws Throwable {				        log.error("Ignoring exception: ", e);				        return null;			        }		        });		try {			executor.execute();		} catch (Throwable t) {			log.error("Exception", t);		}	}}